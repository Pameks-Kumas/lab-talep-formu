<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taleplerim</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

    <style>
        /* --- GENEL TASARIM --- */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; color: #334155; }
        
        .navbar { background: #fff; padding: 15px 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .nav-title { font-weight: 800; font-size: 20px; color: #0f172a; letter-spacing: -0.5px; }
        .btn-logout { color: #ef4444; cursor: pointer; font-weight: 600; padding: 8px 16px; background: #fef2f2; border-radius: 8px; transition: 0.2s; }
        .btn-logout:hover { background: #fee2e2; }

        /* --- FULL WIDTH KONTEYNER --- */
        .container { width: 96%; max-width: 100%; margin: 30px auto; padding: 0; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 24px; font-weight: 700; color: #1e293b; }
        
        .btn-new { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 15px; box-shadow: 0 4px 10px rgba(37,99,235,0.3); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .btn-new:hover { transform: translateY(-2px); }

        /* --- TABLO TASARIMI --- */
        .table-wrapper { background: white; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #e2e8f0; }
        
        /* DataTables Ayarları */
        table.dataTable { width: 100% !important; border-collapse: collapse; }
        table.dataTable thead th { 
            background-color: #f8fafc; color: #475569; padding: 18px 15px; 
            border-bottom: 2px solid #e2e8f0; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        table.dataTable tbody td { 
            padding: 16px 15px; font-size: 14px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; 
            line-height: 1.5; 
        }
        
        .col-kumas { min-width: 250px; max-width: 450px; white-space: normal !important; word-wrap: break-word; }
        .col-kisa { white-space: nowrap; }

        .dataTables_wrapper .dataTables_filter input { border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; outline: none; margin-left: 10px; transition: border 0.3s; }
        .dataTables_wrapper .dataTables_filter input:focus { border-color: #3b82f6; }
        .dataTables_length select { border: 2px solid #e2e8f0; border-radius: 8px; padding: 6px 10px; margin: 0 5px; }

        /* Badge Renkleri */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; display: inline-block; }
        .badge-bekliyor { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-okey { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .badge-red { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-islemde { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }

        /* Buton: İncele */
        .btn-detay { background-color: #f1f5f9; color: #334155; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 13px; transition: 0.2s; border: 1px solid #e2e8f0; cursor: pointer; }
        .btn-detay:hover { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* --- FORM MODAL --- */
        .form-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .form-modal.show { opacity: 1; }
        .form-content { background: #fff; width: 95%; max-width: 750px; border-radius: 20px; padding: 0; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.3s; max-height: 95vh; display: flex; flex-direction: column; }
        .form-modal.show .form-content { transform: scale(1); }
        .form-header { padding: 20px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 20px 20px 0 0; }
        .form-title { font-size: 18px; font-weight: 700; color: #1e293b; }
        .form-close { font-size: 28px; cursor: pointer; color: #94a3b8; }
        .form-body { padding: 25px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; background: #fff; box-sizing: border-box; }
        .form-row { display: flex; gap: 15px; } 
        .renk-section { background: #f1f5f9; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; }
        .renk-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .renk-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
        .btn-add-color { background: #16a34a; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-del-color { background: #dc2626; color: white; border: none; width: 40px; height: 44px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; margin-top: 25px; }
        .form-footer { padding: 20px 25px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 20px 20px; }
        .btn-cancel { padding: 12px 20px; border-radius: 10px; background: #e2e8f0; color: #475569; font-weight: 600; border: none; cursor: pointer; }
        .btn-submit { padding: 12px 25px; border-radius: 10px; background: #3b82f6; color: white; font-weight: 600; border: none; cursor: pointer; }

        /* ALERT MODAL */
        .alert-modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); align-items: center; justify-content: center; }
        .alert-content { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 350px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.3s; }
        .alert-icon { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .icon-success { background: #dcfce7; color: #16a34a; } .icon-error { background: #fee2e2; color: #dc2626; } .icon-warning { background: #fef3c7; color: #d97706; }
        .alert-title { font-size: 18px; font-weight: 700; } .alert-msg { margin-bottom: 20px; color: #64748b; }
        .alert-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; }

        @media (max-width: 480px) { .form-row, .renk-row { flex-direction: column; gap: 10px; } .btn-del-color { width: 100%; height: 35px; margin-top: 0; } }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">Lab Takip</div>
        <div class="user-info">
            <span id="welcomeUser" style="margin-right: 15px; font-weight: 500; color: #475569;">...</span>
            <div onclick="cikisYap()" class="btn-logout">Çıkış</div>
        </div>
    </div>

    <div class="container">
        <div class="header-area">
            <div class="page-title">Taleplerim</div>
            <div class="btn-new" onclick="yeniKayitKontrol()">
                <span>+</span> Yeni Talep
            </div>
        </div>

        <div class="table-wrapper">
            <table id="talepTablosu" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th class="col-kisa">Talep No</th>
                        <th class="col-kisa">Tarih</th>
                        <th>Müşteri</th>
                        <th>Model</th>
                        <th>Kumaş</th>
                        <th>Renk</th>
                        <th style="text-align:center" class="col-kisa">Tur</th>
                        <th class="col-kisa">Durum</th>
                        <th class="col-kisa" style="text-align:center;">İşlem</th>
                    </tr>
                </thead>
                <tbody id="tabloGovdesi"></tbody>
            </table>
        </div>
    </div>

    <div id="newRecordModal" class="form-modal">
        <div class="form-content">
            <div class="form-header"><div class="form-title">Yeni Lab Talebi</div><div class="form-close" onclick="modalKapat()">&times;</div></div>
            <div class="form-body">
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Müşteri</label>
                        <select id="inpMusteri" class="form-select" onchange="musteriSecildi()"><option value="">Yükleniyor...</option></select>
                        <input type="hidden" id="inpSorumlu">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Kumaş Planlamacı</label>
                        <input type="text" id="inpPlanlamaci" class="form-input" readonly style="background-color:#f1f5f9;">
                    </div>
                </div>
                <div class="form-group"><label class="form-label">Model Adı</label><input type="text" id="inpModel" class="form-input"></div>
                
                <div class="form-row">
                    <div class="form-group" style="flex:2">
                        <label class="form-label">Kumaş (Ara)</label>
                        <input list="kumasListesi" id="inpKumas" class="form-input" placeholder="Kod veya Ad yazın..."><datalist id="kumasListesi"></datalist>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Termin</label>
                        <input type="date" id="inpTermin" class="form-input">
                    </div>
                </div>

                <div class="form-group"><label class="form-label">Genel Not</label><textarea id="inpGenelNot" class="form-textarea" rows="2"></textarea></div>

                <div class="renk-section">
                    <div class="renk-header">
                        <span style="font-weight:700;">Renkler / Varyantlar</span>
                        <button class="btn-add-color" onclick="renkEkle()">+ Renk Ekle</button>
                    </div>
                    <div id="renkContainer"></div>
                </div>
            </div>
            <div class="form-footer">
                <button class="btn-cancel" onclick="modalKapat()">İptal</button>
                <button class="btn-submit" onclick="kaydet()">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="alert-modal">
        <div class="alert-content">
            <div id="alertIcon" class="alert-icon">!</div>
            <div id="alertTitle" class="alert-title"></div><div id="alertMsg" class="alert-msg"></div>
            <button id="alertBtn" class="alert-btn" onclick="closeAlert()">Tamam</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="config.js"></script>

    <script>
        var currentUser = "", currentRole = "", musteriListesiCache = [], kumasListesiCache = [];

        window.onload = function() {
            try {
                currentUser = localStorage.getItem("kullaniciAdi");
                currentRole = localStorage.getItem("kullaniciTipi"); 
                if (!currentUser) { window.location.href = "index.html"; return; }
                document.getElementById("welcomeUser").innerText = currentUser + " (" + (currentRole||"User") + ")";
                
                verileriGetir();
                formDropdownlariDoldur(); 
            } catch(e) { console.error(e); }
        };

        function verileriGetir() {
            var fd = new FormData(); fd.append("action", "getKullaniciTalepleri"); fd.append("kullaniciAdi", currentUser);
            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                // Tablo zaten varsa destroy et (yenileme için)
                if ($.fn.DataTable.isDataTable('#talepTablosu')) { $('#talepTablosu').DataTable().destroy(); }
                
                var tbody = document.getElementById("tabloGovdesi"), buf = "";
                
                if(d.data && d.data.length>0) {
                    d.data.forEach(i => {
                        var cls = i.durum.includes("Bekliyor")?"badge-bekliyor":"badge-okey";
                        if(i.durum.includes("Red")) cls="badge-red";
                        if(i.durum.includes("İşlemde")) cls="badge-islemde";

                        var btnHtml = `<button class="btn-detay" onclick="window.location.href='talep-detay.html?no=${i.talepNo}'">İncele</button>`;

                        buf += `<tr>
                            <td class="col-kisa" style="font-weight:700">${i.talepNo}</td>
                            <td class="col-kisa">${tarihFmt(i.tarih)}</td>
                            <td>${i.musteri}</td>
                            <td>${i.model}</td>
                            <td class="col-kumas">${i.kumas}</td>
                            <td>${i.renk}</td>
                            <td style="text-align:center">${i.tur}</td>
                            <td><span class="badge ${cls}">${i.durum}</span></td>
                            <td style="text-align:center">${btnHtml}</td>
                        </tr>`;
                    });
                }
                tbody.innerHTML = buf;
                
                // DATATABLES BAŞLATMA (STATE SAVE: TRUE İLE)
                $('#talepTablosu').DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json' },
                    order: [[0, 'desc']],
                    stateSave: true, // <-- İŞTE O SİHİRLİ AYAR! FİLTRELERİ HATIRLAR.
                    autoWidth: false,
                    columnDefs: [
                        { width: "8%", targets: 0 },
                        { width: "8%", targets: 1 },
                        { width: "10%", targets: 2 },
                        { width: "12%", targets: 3 },
                        { width: "30%", targets: 4 },
                        { width: "10%", targets: 5 },
                        { width: "5%", targets: 6 },
                        { width: "8%", targets: 7 },
                        { width: "8%", targets: 8, orderable: false }
                    ]
                });
            }).catch(e => console.error(e));
        }

        function yeniKayitKontrol() {
            if (currentRole === "Kumaş Planlama") showAlert("warning", "Yetkisiz", "Yeni talebi sadece Müşteri Temsilcisi açabilir.");
            else modalAc();
        }

        function formDropdownlariDoldur() {
            var fd = new FormData(); fd.append("action", "getFormVerileri"); fd.append("kullaniciAdi", currentUser);
            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                if(d.status==="basarili"){
                    musteriListesiCache = d.data.musteriler || [];
                    var mSel = document.getElementById("inpMusteri"), mOpt = "<option value=''>Seçiniz...</option>";
                    musteriListesiCache.forEach(m => { mOpt += `<option value="${m.ad}">${m.ad}</option>`; });
                    mSel.innerHTML = mOpt;

                    var kList = document.getElementById("kumasListesi"), kOpt = "";
                    if(d.data.kumaslar) d.data.kumaslar.forEach(k => { kOpt += `<option value="${k}">`; });
                    kList.innerHTML = kOpt;
                }
            });
        }

        function musteriSecildi() {
            var ad = document.getElementById("inpMusteri").value;
            var obj = musteriListesiCache.find(m=>m.ad==ad);
            document.getElementById("inpPlanlamaci").value = obj ? (obj.planlamaci || "Belirtilmemiş") : "";
        }

        function renkEkle() {
            var id = Date.now();
            var div = document.createElement("div"); div.className = "renk-row"; div.id = "row-"+id;
            div.innerHTML = `<div style="flex:1"><label class="form-label">Renk Adı</label><input type="text" class="form-input inp-renk-ad" placeholder="Mavi"></div><div style="flex:1"><label class="form-label">Ref</label><input type="text" class="form-input inp-renk-ref" placeholder="P-123"></div><div style="flex:1.5"><label class="form-label">Not</label><input type="text" class="form-input inp-renk-not" placeholder="Not"></div><button class="btn-del-color" onclick="document.getElementById('row-${id}').remove()">&times;</button>`;
            document.getElementById("renkContainer").appendChild(div);
        }

        function kaydet() {
            var musteri = document.getElementById("inpMusteri").value;
            var model = document.getElementById("inpModel").value;
            var kumas = document.getElementById("inpKumas").value;
            var termin = document.getElementById("inpTermin").value;
            if(!musteri || !model || !kumas || !termin) { showAlert("warning", "Eksik", "Zorunlu alanları doldurunuz."); return; }
            var renkSatirlari = document.querySelectorAll(".renk-row");
            if(renkSatirlari.length === 0) { showAlert("warning", "Eksik", "En az 1 renk ekleyin."); return; }
            var renkListesi = [];
            renkSatirlari.forEach(row => {
                renkListesi.push({
                    renkAdi: row.querySelector(".inp-renk-ad").value,
                    renkRef: row.querySelector(".inp-renk-ref").value,
                    renkNot: row.querySelector(".inp-renk-not").value
                });
            });
            var btn = document.querySelector(".btn-submit"); btn.innerText="Kaydediliyor..."; btn.disabled=true;
            var fd = new FormData();
            fd.append("action", "kaydet"); fd.append("temsilci", currentUser);
            fd.append("planlamaci", document.getElementById("inpPlanlamaci").value);
            fd.append("musteri", musteri); fd.append("model", model);
            fd.append("kumasTamAd", kumas); fd.append("termin", termin);
            fd.append("genelNot", document.getElementById("inpGenelNot").value);
            fd.append("renklerJSON", JSON.stringify(renkListesi));
            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                btn.innerText="Kaydet"; btn.disabled=false;
                if(d.status==="basarili") { modalKapat(); showAlert("success", "Başarılı", d.message); verileriGetir(); }
                else showAlert("error", "Hata", d.message);
            }).catch(e=>{ btn.innerText="Kaydet"; btn.disabled=false; showAlert("error", "Hata", "Sunucu hatası."); });
        }

        function modalAc() {
            var m = document.getElementById("newRecordModal"); m.style.display="flex"; setTimeout(()=>m.classList.add("show"),10);
            document.getElementById("inpModel").value=""; document.getElementById("inpKumas").value=""; 
            document.getElementById("inpGenelNot").value=""; document.getElementById("renkContainer").innerHTML="";
            renkEkle();
            var d = new Date(); d.setDate(d.getDate()+7); document.getElementById("inpTermin").valueAsDate=d;
        }
        function modalKapat() { document.getElementById("newRecordModal").classList.remove("show"); setTimeout(()=>document.getElementById("newRecordModal").style.display="none",300); }
        function showAlert(t, h, m) { 
            var d = document.getElementById("customAlert"); d.style.display="flex";
            document.getElementById("alertTitle").innerText=h; document.getElementById("alertMsg").innerText=m;
            var i=document.getElementById("alertIcon"), b=document.getElementById("alertBtn");
            i.className="alert-icon"; b.style.background="#334155";
            if(t=="success"){ i.classList.add("icon-success"); i.innerHTML="✓"; b.style.background="#16a34a"; }
            else if(t=="error"){ i.classList.add("icon-error"); i.innerHTML="✕"; b.style.background="#dc2626"; }
            else { i.classList.add("icon-warning"); i.innerHTML="!"; b.style.background="#d97706"; }
        }
        function closeAlert() { document.getElementById("customAlert").style.display="none"; }
        function tarihFmt(s) { if(!s)return""; try{return s.split("T")[0].split("-").reverse().join(".");}catch(e){return s;} }
        function cikisYap() { if(confirm("Çıkış?")) { localStorage.clear(); window.location.href="index.html"; } }
    </script>
</body>
</html>
