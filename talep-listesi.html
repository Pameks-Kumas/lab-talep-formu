<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taleplerim</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- GENEL TASARIM --- */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; color: #334155; }
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .nav-title { font-weight: 800; font-size: 18px; color: #0f172a; }
        .btn-logout { color: #ef4444; cursor: pointer; font-weight: 600; padding: 6px 12px; background: #fef2f2; border-radius: 6px; }
        .container { max-width: 1200px; margin: 25px auto; padding: 0 15px; }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-title { font-size: 22px; font-weight: 700; color: #1e293b; }
        .btn-new { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 18px; border-radius: 10px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 6px rgba(37,99,235,0.2); cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .table-wrapper { background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; color: #475569; font-weight: 600; text-align: left; padding: 16px; border-bottom: 2px solid #e2e8f0; font-size: 12px; text-transform: uppercase; white-space: nowrap; }
        td { padding: 16px; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; }
        .badge-bekliyor { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-okey { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .badge-red { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-islemde { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }

        /* --- GELİŞMİŞ FORM MODAL --- */
        .form-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .form-modal.show { opacity: 1; }
        /* Modal Genişliğini Arttırdık */
        .form-content { background: #fff; width: 95%; max-width: 700px; border-radius: 20px; padding: 0; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.3s; max-height: 95vh; display: flex; flex-direction: column; }
        .form-modal.show .form-content { transform: scale(1); }
        .form-header { padding: 20px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 20px 20px 0 0; }
        .form-title { font-size: 18px; font-weight: 700; color: #1e293b; }
        .form-close { font-size: 28px; cursor: pointer; color: #94a3b8; }
        .form-body { padding: 25px; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 6px; }
        /* Inputları Zorunlu İşaretlemek için CSS */
        .form-label.required::after { content: " *"; color: #dc2626; }
        
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; background: #fff; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        .form-input:focus { border-color: #3b82f6; outline: none; }
        .form-row { display: flex; gap: 15px; } 

        /* RENK LİSTESİ ALANI */
        .renk-section { background: #f1f5f9; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 10px; }
        .renk-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .renk-title { font-size: 14px; font-weight: 700; color: #334155; }
        .btn-add-color { background: #16a34a; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
        
        .renk-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
        .renk-row input { flex: 1; }
        .btn-del-color { background: #dc2626; color: white; border: none; width: 40px; height: 44px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; margin-top: 25px; /* Hizalamak için */ }

        .form-footer { padding: 20px 25px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 20px 20px; }
        .btn-cancel { padding: 12px 20px; border-radius: 10px; background: #e2e8f0; color: #475569; font-weight: 600; border: none; cursor: pointer; }
        .btn-submit { padding: 12px 25px; border-radius: 10px; background: #3b82f6; color: white; font-weight: 600; border: none; cursor: pointer; }

        /* Mobil Uyum */
        @media (max-width: 480px) { 
            .form-row, .renk-row { flex-direction: column; gap: 10px; } 
            .btn-del-color { width: 100%; height: 35px; margin-top: 0; }
            .btn-new span { display: none; }
        }
        
        /* Alert Modal CSS */
        .alert-modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); align-items: center; justify-content: center; }
        .alert-content { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 350px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.3s; }
        .alert-icon { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .icon-success { background: #dcfce7; color: #16a34a; } .icon-error { background: #fee2e2; color: #dc2626; } .icon-warning { background: #fef3c7; color: #d97706; }
        .alert-title { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 8px; }
        .alert-msg { font-size: 14px; color: #64748b; line-height: 1.5; margin-bottom: 20px; }
        .alert-btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; font-size: 15px; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">Lab Takip</div>
        <div class="user-info">
            <span id="welcomeUser" style="margin-right: 10px;">...</span>
            <div onclick="cikisYap()" class="btn-logout">Çıkış</div>
        </div>
    </div>

    <div class="container">
        <div class="header-area">
            <div class="page-title">Taleplerim</div>
            <div class="btn-new" onclick="yeniKayitKontrol()">
                <span>+</span> Yeni Talep
            </div>
        </div>

        <div class="table-wrapper">
            <table id="talepTablosu">
                <thead>
                    <tr><th>Talep No</th><th>Tarih</th><th>Müşteri</th><th>Model</th><th>Kumaş</th><th>Renk</th><th>Durum</th></tr>
                </thead>
                <tbody id="tabloGovdesi">
                    <tr><td colspan="7" style="text-align:center; padding:30px; color:#94a3b8;">Yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="newRecordModal" class="form-modal">
        <div class="form-content">
            <div class="form-header">
                <div class="form-title">Yeni Lab Talebi</div>
                <div class="form-close" onclick="modalKapat()">&times;</div>
            </div>
            
            <div class="form-body">
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label required">Müşteri</label>
                        <select id="inpMusteri" class="form-select" onchange="musteriSecildi()">
                            <option value="">Yükleniyor...</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Kumaş Planlamacı</label>
                        <input type="text" id="inpPlanlamaci" class="form-input" placeholder="Otomatik gelir" readonly style="background-color: #f1f5f9; color: #64748b;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Model Adı</label>
                    <input type="text" id="inpModel" class="form-input" placeholder="Örn: Basic T-Shirt">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:2">
                        <label class="form-label required">Kumaş</label>
                        <input list="kumasListesi" id="inpKumas" class="form-input" placeholder="Kumaş Kodu veya Adı yazın...">
                        <datalist id="kumasListesi">
                            </datalist>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label required">Termin</label>
                        <input type="date" id="inpTermin" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Genel Not</label>
                    <textarea id="inpGenelNot" class="form-textarea" rows="2" placeholder="Talep geneli için not..."></textarea>
                </div>

                <div class="renk-section">
                    <div class="renk-header">
                        <div class="renk-title">Renkler / Varyantlar</div>
                        <button class="btn-add-color" onclick="renkEkle()">+ Renk Ekle</button>
                    </div>
                    <div id="renkContainer">
                        </div>
                </div>

            </div>

            <div class="form-footer">
                <button class="btn-cancel" onclick="modalKapat()">İptal</button>
                <button class="btn-submit" onclick="kaydet()">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="alert-modal">
        <div class="alert-content">
            <div id="alertIcon" class="alert-icon">!</div>
            <div id="alertTitle" class="alert-title">Başlık</div>
            <div id="alertMsg" class="alert-msg">Mesaj</div>
            <button id="alertBtn" class="alert-btn" onclick="closeAlert()">Tamam</button>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        var currentUser = "";
        var currentRole = "";
        var musteriListesiCache = []; 

        window.onload = function() {
            try {
                currentUser = localStorage.getItem("kullaniciAdi");
                currentRole = localStorage.getItem("kullaniciTipi"); 
                if (!currentUser) { window.location.href = "index.html"; return; }
                document.getElementById("welcomeUser").innerText = currentUser + " (" + (currentRole||"") + ")";
                
                verileriGetir();
                formVerileriniYukle();
            } catch(e) { console.error(e); }
        };

        function yeniKayitKontrol() {
            if (currentRole === "Kumaş Planlama") {
                showAlert("warning", "Yetkisiz İşlem", "Yeni talebi sadece Müşteri Temsilcisi açabilir.");
            } else {
                modalAc();
            }
        }

        function verileriGetir() {
            var fd = new FormData();
            fd.append("action", "getKullaniciTalepleri");
            fd.append("kullaniciAdi", currentUser);
            
            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                var tb = document.getElementById("tabloGovdesi");
                var buf = "";
                if(d.data && d.data.length>0) {
                    d.data.forEach(i => {
                        var cls = i.durum.includes("Bekliyor")?"badge-bekliyor":"badge-okey";
                        buf += `<tr><td>${i.talepNo}</td><td>${tarihFmt(i.tarih)}</td><td>${i.musteri}</td><td>${i.model}</td><td>${i.kumas}</td><td>${i.renk}</td><td><span class="badge ${cls}">${i.durum}</span></td></tr>`;
                    });
                    tb.innerHTML = buf;
                } else { tb.innerHTML = "<tr><td colspan='7' style='text-align:center'>Kayıt yok.</td></tr>"; }
            });
        }

        function formVerileriniYukle() {
            var fd = new FormData();
            fd.append("action", "getFormVerileri");
            fd.append("kullaniciAdi", currentUser);

            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                if(d.status==="basarili"){
                    // Müşteriler
                    musteriListesiCache = d.data.musteriler || [];
                    var mSel = document.getElementById("inpMusteri");
                    var mOpt = "<option value=''>Seçiniz...</option>";
                    musteriListesiCache.forEach(m => {
                        mOpt += `<option value="${m.ad}">${m.ad}</option>`;
                    });
                    mSel.innerHTML = mOpt;

                    // Kumaşlar (Datalist için)
                    var kList = document.getElementById("kumasListesi");
                    var kOpt = "";
                    if(d.data.kumaslar) {
                        d.data.kumaslar.forEach(k => {
                            kOpt += `<option value="${k}">`; // k zaten "Kod - Tanım" stringi
                        });
                    }
                    kList.innerHTML = kOpt;
                }
            });
        }

        // Müşteri seçince Planlamacıyı getir
        function musteriSecildi() {
            var ad = document.getElementById("inpMusteri").value;
            var obj = musteriListesiCache.find(m=>m.ad==ad);
            if(obj) {
                document.getElementById("inpPlanlamaci").value = obj.planlamaci || "Belirtilmemiş";
            } else {
                document.getElementById("inpPlanlamaci").value = "";
            }
        }

        // --- RENK SATIRI YÖNETİMİ ---
        function renkEkle() {
            var container = document.getElementById("renkContainer");
            var id = Date.now(); // Benzersiz ID
            var div = document.createElement("div");
            div.className = "renk-row";
            div.id = "row-" + id;
            div.innerHTML = `
                <div style="flex:1">
                    <label class="form-label">Renk Adı</label>
                    <input type="text" class="form-input inp-renk-ad" placeholder="Mavi">
                </div>
                <div style="flex:1">
                    <label class="form-label">Renk Ref (Pantone)</label>
                    <input type="text" class="form-input inp-renk-ref" placeholder="P-123">
                </div>
                <div style="flex:1.5">
                    <label class="form-label">Renk Notu</label>
                    <input type="text" class="form-input inp-renk-not" placeholder="Örn: Açık ton">
                </div>
                <button class="btn-del-color" onclick="renkSil('${id}')">&times;</button>
            `;
            container.appendChild(div);
        }

        function renkSil(id) {
            var row = document.getElementById("row-" + id);
            if(row) row.remove();
        }

        // --- KAYDET ---
        function kaydet() {
            // Zorunlu Alan Kontrolü
            var musteri = document.getElementById("inpMusteri").value;
            var model = document.getElementById("inpModel").value;
            var kumas = document.getElementById("inpKumas").value;
            var termin = document.getElementById("inpTermin").value;

            if(!musteri || !model || !kumas || !termin) {
                showAlert("warning", "Eksik Bilgi", "Lütfen Müşteri, Model, Kumaş ve Termin alanlarını doldurun.");
                return;
            }

            // Renkleri Topla
            var renkSatirlari = document.querySelectorAll(".renk-row");
            if(renkSatirlari.length === 0) {
                showAlert("warning", "Eksik Bilgi", "En az 1 adet renk eklemelisiniz.");
                return;
            }

            var renkListesi = [];
            var renkEksik = false;
            renkSatirlari.forEach(row => {
                var ad = row.querySelector(".inp-renk-ad").value;
                var ref = row.querySelector(".inp-renk-ref").value;
                var not = row.querySelector(".inp-renk-not").value;
                if(!ad) renkEksik = true;
                renkListesi.push({ renkAdi: ad, renkRef: ref, renkNot: not });
            });

            if(renkEksik) {
                showAlert("warning", "Eksik Bilgi", "Lütfen tüm renklerin 'Renk Adı' alanını doldurun.");
                return;
            }

            // Backend'e Gönder
            var btn = document.querySelector(".btn-submit");
            btn.innerText = "Kaydediliyor...";
            btn.disabled = true;

            var fd = new FormData();
            fd.append("action", "kaydet");
            fd.append("temsilci", currentUser);
            fd.append("planlamaci", document.getElementById("inpPlanlamaci").value);
            fd.append("musteri", musteri);
            fd.append("model", model);
            fd.append("kumasTamAd", kumas); // Kod ve Tanım birleşik gidiyor
            fd.append("termin", termin);
            fd.append("genelNot", document.getElementById("inpGenelNot").value);
            // Renk listesini String olarak gönderiyoruz
            fd.append("renklerJSON", JSON.stringify(renkListesi));

            fetch(SCRIPT_URL, { method: "POST", body: fd }).then(r=>r.json()).then(d=>{
                btn.innerText = "Kaydet"; btn.disabled = false;
                if(d.status === "basarili") {
                    modalKapat();
                    showAlert("success", "Başarılı", d.message);
                    verileriGetir();
                } else {
                    showAlert("error", "Hata", d.message);
                }
            }).catch(e => {
                btn.innerText = "Kaydet"; btn.disabled = false;
                showAlert("error", "Hata", "Sunucu hatası.");
            });
        }

        // --- UI ---
        function modalAc() {
            var m = document.getElementById("newRecordModal");
            m.style.display = "flex";
            setTimeout(() => m.classList.add("show"), 10);
            
            // Sıfırla ve İlk Rengi Ekle
            document.getElementById("inpModel").value = "";
            document.getElementById("inpKumas").value = "";
            document.getElementById("inpGenelNot").value = "";
            document.getElementById("renkContainer").innerHTML = ""; 
            renkEkle(); // En az 1 renk satırı olsun

            var bugun = new Date(); bugun.setDate(bugun.getDate() + 7);
            document.getElementById("inpTermin").valueAsDate = bugun;
        }
        function modalKapat() { document.getElementById("newRecordModal").classList.remove("show"); setTimeout(()=>document.getElementById("newRecordModal").style.display="none",300); }
        
        function showAlert(type, title, msg) {
            var m = document.getElementById("customAlert");
            var icon = document.getElementById("alertIcon");
            var btn = document.getElementById("alertBtn");
            document.getElementById("alertTitle").innerText = title;
            document.getElementById("alertMsg").innerText = msg;
            icon.className = "alert-icon"; btn.style.background = "#334155";
            if(type === "success") { icon.classList.add("icon-success"); icon.innerHTML = "✓"; btn.style.background = "#16a34a"; }
            else if(type === "error") { icon.classList.add("icon-error"); icon.innerHTML = "✕"; btn.style.background = "#dc2626"; }
            else { icon.classList.add("icon-warning"); icon.innerHTML = "!"; btn.style.background = "#d97706"; }
            m.style.display = "flex";
        }
        function closeAlert() { document.getElementById("customAlert").style.display = "none"; }
        function tarihFmt(s) { if(!s)return""; try{ return s.split("T")[0].split("-").reverse().join("."); }catch(e){return s;} }
        function cikisYap() { if(confirm("Çıkış?")) { localStorage.clear(); window.location.href="index.html"; }}
    </script>
</body>
</html>
